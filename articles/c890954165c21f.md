---
title: "Rustã¨github actionsã§CIç’°å¢ƒæ§‹ç¯‰"
emoji: "ğŸ¦€"
type: "tech"
topics: ["rust", "test", "github actions", "ci"]
published: true
date: '2021/09/24'
---

## ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³
Rustã®privateãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§CIã‚’é‹ç”¨ã™ã‚‹ä¸Šã§ã€ä»Šã¾ã§CircleCIã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã—ãŸãŒã€github actionsã«é›†ç´„ã—ãŸæ–¹ãŒè‰²ã€…ã¨æ—ã‚Šãã†ã ã£ãŸã®ã§ç§»è¡Œã—ã‚ˆã†ã¨æ€ã„ã¾ã—ãŸã€‚
ã“ã®è¨˜äº‹ã§ã¯ãã®éš›ã«æ¤œè¨ã—ãŸã“ã¨ã‚„ã€å‚è€ƒã«ã—ãŸã‚‚ã®ã‚’å…±æœ‰ã‚’ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

## æƒ³å®šèª­è€…
- Rustã§CIã‚’é‹ç”¨ã—ãŸã„ã¨æ€ã£ã¦ã„ã‚‹äºº
- github actionsã‚’ä½¿ã£ã¦CIã‚’é‹ç”¨ã—ãŸã„ã¨æ€ã£ã¦ã„ã‚‹äºº

## æ³¨æ„äº‹é …
ä»Šå›CIã‚’æ§‹ç¯‰ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ã‚µãƒ¼ãƒã‚’Rustã€ãƒ•ãƒ­ãƒ³ãƒˆã‚’Next.jsã§æ§‹ç¯‰ã—ã¦ã„ã¦ä¸¡è€…ã‚’åŒã˜ãƒªãƒã‚¸ãƒˆãƒª(ãƒ¢ãƒãƒªãƒ)ã§ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚
gitãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã¯ãªãserverã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…éƒ¨ãŒRustã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€ä»Šå›ã®workflowãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ãã®å½±éŸ¿ã‚’å—ã‘ã¦ã„ã¾ã™ã€‚
å…·ä½“çš„ã«ã¯working-directory: serverã¨ã‹cacheãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹ãŒserver/target/ã«ãªã£ã¦ã„ã‚‹ã®ãŒãã‚Œã§ã€ãƒ«ãƒ¼ãƒˆã«Cargo.tomlã‚’é…ç½®ã™ã‚‹å ´åˆã¯ã€working-directoryã®æŒ‡å®šã¯ä¸è¦ã«ãªã£ãŸã‚Šã€target/ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚Œã°è‰¯ã„ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
ä»¥ä¸‹ãŒä»Šå›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆå›³ã§ã™ã€‚
```
. # â† gitãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã¯ã“ã“
â”œâ”€â”€ .git
â”œâ”€â”€ .github
â”‚   â”œâ”€â”€ actions
â”‚   â”‚   â””â”€â”€ cache_cargo
â”‚   â”‚       â””â”€â”€ action.yml
â”‚   â””â”€â”€ workflows
â”‚       â””â”€â”€ rust_ci.yml
â”œâ”€â”€ ...
â””â”€â”€ server # â† Rustãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã¯ã“ã“
    â”œâ”€â”€ ...
    â””â”€â”€ Cargo.toml 
```

## actionã®ä½œæˆ
actionã¯å…±é€šå‡¦ç†ã‚’æŠ½å‡ºã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã§ã€ã„ã‚ã‚†ã‚‹é–¢æ•°å®šç¾©ã¨åŒã˜ã‚ˆã†ãªã“ã¨ãŒã§ãã¾ã™ã€‚
CircleCIã§ã¯jobã¨å‘¼ã°ã‚Œã¦ã„ã‚‹æ©Ÿèƒ½ã¨ã»ã¼åŒã˜ã ã¨æ€ã‚ã‚Œã¾ã™ãŒã€CircleCIã®jobã¨ã¯ç•°ãªã‚Šã€workflowã®yamlã«ç›´æ¥actionã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã¯ã§ããšã€1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã¤ã1ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä¸‹è¨˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä»Šå›ä½œæˆã—ãŸyamlãƒ•ã‚¡ã‚¤ãƒ«ã§ã€buildã«æœ‰ç”¨ãªãƒ‡ãƒ¼ã‚¿ã‚’cacheã™ã‚‹actionã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚
```yml:.github/actions/cache_cargo/action.yml
name: cache_cargo
description: caching .cargo directory
runs:
  using: composite

  steps:
    - name: Cache cargo registry
      uses: actions/cache@v2
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          server/target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ runner.os }}-cargo-
```
ã“ã®yamlãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ›¸ãæ–¹ã§workflowã‹ã‚‰å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚
```
- uses: ./.github/actions/cache_cargo
```

## workflowã®ä½œæˆ
github actionsã‚’åˆ©ç”¨ã—ã¦CIã‚’å®Ÿéš›ã«å‹•ã‹ã™ã«ã¯workflowã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä¸‹è¨˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä»Šå›ä½œæˆã—ãŸyamlãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã‚Šã¾ã™ã€‚
ä»Šå›ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯
1. äº‹å‰ã«cargo buildã‚’å®Ÿè¡Œã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆã™ã‚‹
2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã—ã¦
  2-a. rustfmtã‚’åˆ©ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
  2-b. clippyã‚’åˆ©ç”¨ã—ãŸé™çš„è§£æ
  2-c. è‡ªå‹•ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ(postgresã‚’ç”¨ã„ãŸdatabaseãƒ†ã‚¹ãƒˆã‚‚å¯èƒ½)
  
ã¨ã„ã†æ§‹æˆã«ãªã£ã¦ã„ã¦ã€æœ€ä½é™ã®æ§‹æˆã«ãªã£ã¦ã„ã¾ã™ã€‚

æœ¬å½“ã¯tarpaulinã‚’ç”¨ã„ã¦coverageã®å–å¾—ãªã©ã‚‚ã—ãŸã‹ã£ãŸã§ã™ãŒã€cacheãŒã†ã¾ãåŠ¹ã‹ãªã„ã®ã§ä¸€æ—¦offã«ã—ã¦ã„ã¾ã™ã€‚
(RUSTC_FORCE_INCREMENTAL: 1ã¯æ„å‘³ãŒãªã„ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ãŒå‚è€ƒæ–‡çŒ®ã‚’ãªã‚‰ã£ã¦ä¸€å¿œå…¥ã‚Œã¦ã¾ã™ã€‚)

```yml:.github/workflows/rust_ci.yml
on: push

jobs:
  build_cache:
    runs-on: ubuntu-latest
    env:
      RUSTC_FORCE_INCREMENTAL: 1
    steps:
      - uses: actions/checkout@v2
      - uses: ./.github/actions/cache_cargo
      - name: build
        run: cargo build
        working-directory: server

  fmt:
    runs-on: ubuntu-latest
    needs: build_cache
    steps:
      - uses: actions/checkout@v2
      - run: rustup component add rustfmt
      - uses: ./.github/actions/cache_cargo
      - name: fmt
        run: cargo fmt --all -- --check
        working-directory: server

  clippy:
    runs-on: ubuntu-latest
    env:
      RUSTC_FORCE_INCREMENTAL: 1
    needs: build_cache
    steps:
      - uses: actions/checkout@v2
      - run: rustup component add clippy
      - uses: ./.github/actions/cache_cargo
      - name: clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        working-directory: server

  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:12
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    env:
      RUSTC_FORCE_INCREMENTAL: 1
    needs: build_cache
    steps:
      - name: create database for test
        run: PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE DATABASE test"
      - uses: actions/checkout@v2
      - uses: ./.github/actions/cache_cargo
      - name: test
        run: cargo test --all -- --nocapture
        working-directory: server

```

## å‚è€ƒæ–‡çŒ®
### workflowã®ã‚µãƒ³ãƒ—ãƒ«
ã“ã‚Œã‚‰ã¯éå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚
[denoã®workflow](https://github.com/actix/actix-web/tree/master/.github/workflows)  
[actix-webã®workflow](https://github.com/actix/actix-web/tree/master/.github/workflows)  
[actions/cache@v2ã®Rustã§ã®ã‚µãƒ³ãƒ—ãƒ«](https://github.com/actions/cache/blob/main/examples.md#rust---cargo)

### sccacheã®æ¤œè¨
sccacheã¨ã„ã†ãƒ—ãƒ­ã‚°ãƒ©ãƒ åˆ©ç”¨ã§ã€ãƒ“ãƒ«ãƒ‰ã‚’é«˜é€ŸåŒ–ã§ãã‚‹ã¨ã„ã†è©±ã§è©¦é¨“å°å…¥ã—ã¦ã¿ã¾ã—ãŸãŒã€ã‚ã¾ã‚ŠåŠ¹æœã‚’å®Ÿæ„Ÿã§ãã‚‹ã‚ˆã†ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚µã‚¤ã‚ºã§ã¯ãªã„ã®ã§è¦‹é€ã‚Šã¾ã—ãŸã€‚

[sccacheã§GitHub Actionsä¸Šã®Rustãƒ“ãƒ«ãƒ‰ã‚’é«˜é€ŸåŒ–ã™ã‚‹ã‚„ã¤è©¦ã—ãŸ](https://blog.endflow.net/speedup-rust-build/)  
[GitHub Actions best practices for Rust projects](https://www.infinyon.com/blog/2021/04/github-actions-best-practices/)

### incremental buildã®æ¤œè¨
mtimeã‚’å¾©å…ƒã™ã‚‹ã“ã¨ã§incremental buildãŒã§ãã‚‹ã‚‰ã—ã„ã¨ã®ã“ã¨ã§ã™ãŒã€checkoutãŒé‡ãŸããªã‚Šãã†ã ã¨æ€ã£ãŸã®ã¨ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚µã‚¤ã‚ºãŒãã“ã¾ã§å¤§ãããªã„ã®ã§ã€å¤–éƒ¨ã‚¯ãƒ¬ãƒ¼ãƒˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã§ãã‚Œã°ã¾ãšã¯ååˆ†ã ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚

[Rust ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® GitHub Actions ã§ incremental build ã‚’ã™ã‚‹ãŸã‚ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯](https://zenn.dev/kt3k/articles/d557cc874961ab)